---
title: "Markov Language Chains"
author: "Kylei Hoffland, Camille Kich, Brandon Winder, Alex Mix"
date: "5/13/2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(stringr)
library(tm)
library(lubridate)
library(tidytext)
```

## Review Collection and Cleaning

Reviews for wine less than $15

```{r}
#1094 pages with useful reviews
pre <- "https://www.winespectator.com/dailypicks/category/catid/1/page/"
post <- 1:200
links <- paste(pre, post, sep = "")
links <- as.data.frame(links)

```

```{r}
gather_reviews <- function(url) {
  page <- read_html(url)
  reviews <- html_nodes(page, ".mr-md-32")
  reviews <- html_text(reviews, trim = TRUE)
  
  #splits the long string of all reviews into separate reviews (using the date as the splitter)
  dates <- str_extract_all(reviews, "(.){4}\\s(\\d{2}),\\s(\\d{4})")
  reviews <- str_split(reviews, "(.){4}\\s(\\d{2}),\\s(\\d{4})")
  
  #adds date back to review and converts to vector
  dates <- unlist(dates)
  dates <- str_c(dates, " ")
  reviews <- unlist(reviews)
  reviews <- reviews[-1]
  reviews <- str_trim(reviews)
  reviews <- str_c(dates, reviews)
}

#get reviews for every link and then convert to a data frame with one review per row
all_reviews <- apply(links, 1, gather_reviews) %>% as.data.frame()
all_reviews <- pivot_longer(all_reviews, V1:V200, values_to = "Reviews")
all_reviews <- all_reviews[, -1]
```

```{r}
#convert to strings, remove extra garbage (\n and spaces, spaces > 4 replaced by '~')
all_reviews[] <- lapply(all_reviews, as.character)

for (i in 1:1000) {
  all_reviews[i,1] <- str_replace_all(all_reviews[i,1], "[\n]", "")
  all_reviews[i,1] <- str_replace_all(all_reviews[i,1], "\\s{4,}", "~")
}

#seperate into columns by date/rating/name and type/review (seperation character is '~')
all_reviews <- all_reviews %>% separate(Reviews, c("Date", "Score", "Maker", "Name", "Price", "Review", "Reviewer"), sep = "~", extra = "merge")
all_reviews <- all_reviews %>% separate(Date, c("Date", "Score"), sep = -2, remove = FALSE)
```

```{r}
#Creates a variable for the last 2 sentences
all_reviews <- all_reviews %>% mutate(last2 = " ")
#Loops for each wine review and extracts the last 2 sentences and puts it into the variable last2
for (i in 1:1000){
  x <- str_locate(all_reviews$Review[i], "Drink")
#There is 9 times that "Best after" should be used insted of "Drink" but I couldn't get a ifelse statement to work if you have any ideas

  all_reviews$last2[i] <- str_sub(all_reviews$Review[i], start = x[1])
}
#Removes the last two sentences from Review
all_reviews <- all_reviews %>% mutate(Review = str_remove(Review, last2))
#Removes the rows that contain NA values
all_reviews <- na.omit(all_reviews)
#Seperates the last2 variable into Drink and Cases
all_reviews <- all_reviews %>% separate(last2, c("Drink", "Cases", "Extra"), sep = "\\. ", fill = "right")
#Determines which rows have additional pieces in the last 2 sentences
extra <- which(complete.cases(all_reviews))
#Removes the rows that have additional pieces in the last 2 sentences 
all_reviews <- all_reviews[-extra, ]
#Removes the variable Extra which contains all NA values
all_reviews <- subset(all_reviews, select = -Extra)
```

```{r}
#Removes the dollar sign from the price variable and makes it numeric.
all_reviews <- all_reviews %>% mutate(Price = as.numeric(str_remove_all(Price, "\\$")))

#Turns the date variable from a character into a Date
all_reviews <- all_reviews %>% mutate(Date = mdy(Date))

#Replaces the dashes in Names with a space
all_reviews <- all_reviews %>% mutate(Name = str_replace_all(Name, "-", " "))

#Removes the dashes in front of the Reviewer
all_reviews <- all_reviews %>% mutate(Reviewer = substring(Reviewer, 2))

#This way makes a new variable 'ReviewPunct' with all the punctuation for each review and removes the punctuation within the Review variable.
  ##all_reviews <- all_reviews %>% mutate(ReviewPunct = str_extract_all(Review, "[:punct:]")) %>% mutate(Review = removePunctuation(Review)) 

#This way seperates the punctuation under the Review variable by adding a space before and after the punctuation.
all_reviews <- all_reviews %>% mutate(Review = str_replace_all(Review, ",", " ,")) %>% mutate(Review = str_replace_all(Review, "\\.", " .")) %>% mutate(Review = str_replace_all(Review, "-", " - "))

#This way makes a new variable 'CasesPunct' with all the punctuation for each of the Cases variable and removes the punctuation within the Cases variable.
  ##all_reviews <- all_reviews %>% mutate(CasesPunct = str_extract_all(Cases, "[:punct:]")) %>% mutate(Cases = removePunctuation(Cases))

#This way seperates the punctuation under the Cases variable by adding a space before and after the punctuation.
all_reviews <- all_reviews %>% mutate(Cases = str_replace_all(Cases, ",", " , ")) %>% mutate(Cases = str_replace_all(Cases, "\\.", " .")) %>% mutate(Cases = str_replace_all(Cases, "-", " - "))
```


## Markov Chain Review Generation Function

```{r}
#Split words into pairs
review_w <- all_reviews["Review"]
review_w <- review_w %>% unnest_tokens(words, Review, token = "words", strip_punct = FALSE)
word_2 <- review_w[-1,1]
word_2[26522,1] = " "
review_w <- cbind(review_w, word_2)
colnames(review_w) <- c("Word 1", "Word 2")

#Count the number of times each combination occurs (n)
count <- review_w %>% count(`Word 1`, `Word 2`, sort = TRUE)

#Probablility of that combination ('pairs' is the final dataframe)
probability <- (count$n/nrow(count))
pairs <- cbind(count, probability)

```

Here's a spot for the function

```{r}

```

## Spruce It Up and Then Spruce It Up More

Do that here

```{r}

```

